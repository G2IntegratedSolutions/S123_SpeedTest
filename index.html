<!DOCTYPE html>
<html>
<head>
    <title>Internet Speed Test Survey</title>
    <!-- Include Survey123 Web Form JavaScript API -->
    <script src="https://survey123.arcgis.com/api/jsapi"></script>
    <!-- Include M-Lab NDT JavaScript library -->
    <script src="https://cdn.jsdelivr.net/gh/m-lab/ndt7-js/src/ndt7.min.js"></script>
    <!-- Add CSS to style the page -->
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #survey123Container {
            width: 100%;
            height: calc(100% - 60px);
            overflow: auto;
        }
        #runSpeedTest {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <button id="runSpeedTest">Run Speed Test</button>
    <div id="survey123Container"></div>
    <script>
        // Initialize the Survey123 Web Form
        var survey123WebForm = new Survey123WebForm({
            itemId: "d76488086d8a4fae8ab8c3a84b0496ac", // Replace with your form's item ID
            container: "survey123Container"
        });

        // Function to run the NDT Speed Test
        function runSpeedTest() {
            // Disable the button to prevent multiple clicks
            document.getElementById("runSpeedTest").disabled = true;
            document.getElementById("runSpeedTest").innerText = "Running...";

            // Initialize the NDT7 client
            //const client = new ndt7.NDT7Client();

            // Variables to store results
            let downloadSpeed = 0;
            let uploadSpeed = 0;
            let latency = 0;

            //Start the test
            ndt7.test(
                {
                    userAcceptedDataPolicy: true, // Required by M-Lab's policy
                    downloadWorkerScript: 'ndt7-download-worker.min.js',
                    uploadWorkerScript: 'ndt7-upload-worker.min.js'
                },
                {
                    serverChosen: function(server) {
                        console.log('Testing to:', server);
                    },
                    downloadMeasurement: function(measurement) {
                        console.log('Download measurement:', measurement);
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            downloadSpeed = (measurement.Data.MeanClientMbps).toFixed(2); // Mbps
                            console.log('Download Speed:', downloadSpeed);
                        }
                        if (measurement.Source === 'server' && measurement.Data.BBRInfo && measurement.Data.BBRInfo.MinRTT) {
                            latency = (measurement.Data.BBRInfo.MinRTT / 1000).toFixed(2); // ms
                            console.log('Latency:', latency);
                        }
                    },
                    uploadMeasurement: function(measurement) {
                        console.log('Upload measurement:', measurement);
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            uploadSpeed = (measurement.Data.MeanClientMbps).toFixed(2); // Mbps
                            console.log('Upload Speed:', uploadSpeed);
                        }
                    }
                }

            ).then(() => {
                // Populate the survey fields with results
                survey123WebForm.setQuestionValue('download_speed', parseFloat(downloadSpeed));
                survey123WebForm.setQuestionValue('upload_speed', parseFloat(uploadSpeed));
                survey123WebForm.setQuestionValue('latency', parseFloat(latency));

                // Re-enable the button
                document.getElementById("runSpeedTest").disabled = false;
                document.getElementById("runSpeedTest").innerText = "Run Speed Test";
                }).catch((error) => {
                    console.error('NDT7 Error:', error);
                    alert("Speed test failed. Please try again.");
                    // Re-enable the button
                    document.getElementById("runSpeedTest").disabled = false;
                    document.getElementById("runSpeedTest").innerText = "Run Speed Test";
                });
            }

        // Add event listener to the button
        document.getElementById("runSpeedTest").addEventListener("click", runSpeedTest); 
    </script>
</body>
</html>