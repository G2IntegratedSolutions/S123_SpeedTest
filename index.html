<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test</title>
    <script src="https://cdn.jsdelivr.net/gh/m-lab/ndt7-js/src/ndt7.min.js"></script>
</head>
<body>
    <h1>Internet Speed Test</h1>
    <button id="startTest">Start Test</button>
    <p id="status">Status: Not started</p>
    <p id="downloadSpeed">Download Speed: N/A</p>
    <p id="uploadSpeed">Upload Speed: N/A</p>
    <p id="latency">Latency: N/A</p>

    <script>
        document.getElementById('startTest').addEventListener('click', function() {
            document.getElementById('status').innerText = 'Status: Testing...';

            ndt7.test(
                {
                    userAcceptedDataPolicy: true,
                    downloadWorkerScript: 'ndt7-download-worker.min.js',
                    uploadWorkerScript: 'ndt7-upload-worker.min.js'
                },
                {
                    serverChosen: function(server) {
                        console.log('Testing to:', server);
                    },
                    downloadMeasurement: function(measurement) {
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            document.getElementById('downloadSpeed').innerText = 'Download Speed: ' + measurement.Data.MeanClientMbps.toFixed(2) + ' Mbps';
                        }
                        if (measurement.Data && measurement.Data.MinRTT) {
                            document.getElementById('latency').innerText = 'Latency: ' + measurement.Data.MinRTT.toFixed(2) + ' ms';
                        }
                    },
                    uploadMeasurement: function(measurement) {
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            document.getElementById('uploadSpeed').innerText = 'Upload Speed: ' + measurement.Data.MeanClientMbps.toFixed(2) + ' Mbps';
                        }
                    },
                    complete: function() {
                        document.getElementById('status').innerText = 'Status: Complete';
                        sendResultsToSurvey123();
                    },
                    error: function(err) {
                        console.error('Error during test:', err);
                        document.getElementById('status').innerText = 'Status: Error';
                    }
                }
            );
        });

        function sendResultsToSurvey123() {
            var downloadSpeed = document.getElementById('downloadSpeed').innerText.split(': ')[1];
            var uploadSpeed = document.getElementById('uploadSpeed').innerText.split(': ')[1];
            var latency = document.getElementById('latency').innerText.split(': ')[1];

            if (latency === 'N/A') {
                latency = '0'; // Default value if latency is not available
            }

            var survey123Url = 'arcgis-survey123://?itemID=fc3216bbdfe6487faf61bce5b5efb588&field:download_speed=' + downloadSpeed + '&field:upload_speed=' + uploadSpeed + '&field:latency=' + latency;
            window.location.href = survey123Url;
        }
    </script>
</body>
</html>