<!DOCTYPE html>
<html>
<head>
    <title>Internet Speed Test Survey</title>
    <!-- Include Survey123 Web Form JavaScript API -->
    <script src="https://survey123.arcgis.com/api/jsapi"></script>
    <!-- Include M-Lab NDT JavaScript library -->
    <script src="https://cdn.jsdelivr.net/gh/m-lab/ndt7-js/src/ndt7.min.js"></script>
    <!-- Add CSS to style the page -->
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #survey123Container {
            width: 100%;
            height: calc(100% - 60px);
            overflow: auto;
        }
        .custom-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            background-color: #0079c1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }
        .custom-button:hover {
            background-color: #005a8c;
        }
    </style>
</head>
<body>
    <div id="survey123Container"></div>
    <script>
        // Initialize the Survey123 Web Form
        var survey123WebForm = new Survey123WebForm({
            itemId: "d76488086d8a4fae8ab8c3a84b0496ac", // Replace with your form's item ID
            container: "survey123Container",
        });

        // Function to run the NDT Speed Test
        function runSpeedTest() {
            // Disable the button to prevent multiple clicks
            document.getElementById("runSpeedTest").disabled = true;
            document.getElementById("runSpeedTest").innerText = "Running...";

            // Initialize the NDT7 client
            let downloadSpeed = 0;
            let uploadSpeed = 0;
            let latency = 0;

            // Start the test
            ndt7.test(
                {
                    userAcceptedDataPolicy: true, // Required by M-Lab's policy
                    downloadWorkerScript: 'ndt7-download-worker.min.js',
                    uploadWorkerScript: 'ndt7-upload-worker.min.js'
                },
                {
                    serverChosen: function(server) {
                        console.log('Testing to:', server);
                    },
                    downloadMeasurement: function(measurement) {
                        console.log('Download measurement:', measurement);
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            downloadSpeed = (measurement.Data.MeanClientMbps).toFixed(2); // Mbps
                            console.log('Download Speed:', downloadSpeed);
                        }
                        if (measurement.Source === 'server' && measurement.Data.BBRInfo && measurement.Data.BBRInfo.MinRTT) {
                            latency = (measurement.Data.BBRInfo.MinRTT / 1000).toFixed(2); // ms
                            console.log('Latency:', latency);
                        }
                    },
                    uploadMeasurement: function(measurement) {
                        console.log('Upload measurement:', measurement);
                        if (measurement.Data && measurement.Data.MeanClientMbps) {
                            uploadSpeed = (measurement.Data.MeanClientMbps).toFixed(2); // Mbps
                            console.log('Upload Speed:', uploadSpeed);
                        }
                    }
                }
            ).then(() => {
                // Populate the survey fields with results
                survey123WebForm.setQuestionValue({'download_speed': parseFloat(downloadSpeed)});
                survey123WebForm.setQuestionValue({'upload_speed': parseFloat(uploadSpeed)});
                survey123WebForm.setQuestionValue({'latency': parseFloat(latency)});

                // Re-enable the button
                document.getElementById("runSpeedTest").disabled = false;
                document.getElementById("runSpeedTest").innerText = "Run Speed Test";
            }).catch((error) => {
                console.error('NDT7 Error:', error);
                alert("Speed test failed. Please try again.");
                // Re-enable the button
                document.getElementById("runSpeedTest").disabled = false;
                document.getElementById("runSpeedTest").innerText = "Run Speed Test";
            });
        }

        // Function to add the custom button
        function addCustomButton() {
            console.log('Adding custom button...');
            const customButton = document.createElement('button');
            customButton.id = 'runSpeedTest';
            customButton.innerText = 'Run Speed Test';
            customButton.className = 'custom-button';

            // Find the Download Speed field and insert the button above it
            const iframe = document.querySelector('#survey123Container iframe');
            if (iframe) {
                console.log('Iframe found:', iframe);
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                console.log('Iframe document ready state:', iframeDoc.readyState);
                const downloadSpeedField = iframeDoc.querySelector('[data-question-name="download_speed"]');
                console.log('Download Speed field:', downloadSpeedField);
                if (downloadSpeedField) {
                    downloadSpeedField.parentNode.insertBefore(customButton, downloadSpeedField);
                    console.log('Button added to the form.');
                } else {
                    console.log('Download Speed field not found.');
                }
            } else {
                console.log('Iframe not found.');
            }

            // Add event listener to the custom button
            customButton.addEventListener('click', runSpeedTest);
        }

        // MutationObserver to detect when the Survey123 form is loaded
        const observer = new MutationObserver((mutationsList, observer) => {
            console.log('MutationObserver triggered.');
            const iframe = document.querySelector('#survey123Container iframe');
            if (iframe && iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                addCustomButton();
                observer.disconnect(); // Stop observing once the button is added
            }
        });

        // Start observing the survey123Container for changes
        document.addEventListener("DOMContentLoaded", function() {
            const surveyContainer = document.getElementById('survey123Container');
            observer.observe(surveyContainer, { childList: true, subtree: true });
        });

        // Fallback to ensure the button is added if MutationObserver fails
        function ensureButtonAdded() {
            console.log('Ensuring button is added...');
            const iframe = document.querySelector('#survey123Container iframe');
            if (iframe) {
                console.log('Iframe found:', iframe);
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                console.log('Iframe document ready state:', iframeDoc.readyState);
                if (iframeDoc.readyState === 'complete') {
                    addCustomButton();
                }
            } else {
                console.log('Iframe not found.');
            }
            setTimeout(ensureButtonAdded, 1000); // Check again after 1 second
        }

        // Start the fallback mechanism
        ensureButtonAdded();
    </script>
</body>
</html>