<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test</title>
    <!-- <script src="https://github.com/m-lab/ndt7-js/blob/main/src/ndt7.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/gh/m-lab/ndt7-js/src/ndt7.min.js"></script>
    <!-- <script !function(){"use strict";const e=function(){const e={client_library_name:"ndt7-js",client_library_version:"0.0.6"},t=function(e,t,r){return void 0!==t&&e in t?t[e]:void 0!==r?r:function(){}},r=function(e){throw new Error(e)};async function a(a,o){a.metadata=Object.assign({},a.metadata),a.metadata=Object.assign(a.metadata,e);const n={error:t("error",o,r),serverDiscovery:t("serverDiscovery",o),serverChosen:t("serverChosen",o)};let s="wss";a&&"protocol"in a&&(s=a.protocol);const d=new URLSearchParams(a.metadata);if(a&&"server"in a){const e=new URL(s+"://"+a.server+"/ndt/v7/download"),t=new URL(s+"://"+a.server+"/ndt/v7/upload");return e.search=d,t.search=d,{"///ndt/v7/download":e.toString(),"///ndt/v7/upload":t.toString()}}const c=a&&"loadbalancer"in a?new URL(a.loadbalancer):new URL("https://locate.measurementlab.net/v2/nearest/ndt/ndt7");c.search=d,n.serverDiscovery({loadbalancer:c});const l=await fetch(c).catch((e=>{throw new Error(e)})),i=await l.json();if(!("results"in i))return n.error(`Could not understand response from ${c}: ${i}`),{};const u=i.results[0];return n.serverChosen(u),{"///ndt/v7/download":u.urls[s+":///ndt/v7/download"],"///ndt/v7/upload":u.urls[s+":///ndt/v7/upload"]}}const o=async function(e,t,r,a,o){if(!0!==e.userAcceptedDataPolicy&&!0!==e.mlabDataPolicyInapplicable)return t.error("The M-Lab data policy is applicable and the user has not explicitly accepted that data policy."),1;let n,s;const d=new Worker(a),c=new Promise((e=>{d.resolve=function(r){0==r&&t.complete({LastClientMeasurement:n,LastServerMeasurement:s}),d.terminate(),e(r)}})),l=setTimeout((()=>d.resolve(0)),12e3);d.onmessage=function(e){if(e.data&&e.data.MsgType&&"error"!==e.data.MsgType)"start"===e.data.MsgType?t.start(e.data.Data):"measurement"==e.data.MsgType?"server"==e.data.Source?(s=JSON.parse(e.data.ServerMessage),t.measurement({Source:e.data.Source,Data:s})):(n=e.data.ClientData,t.measurement({Source:e.data.Source,Data:e.data.ClientData})):"complete"==e.data.MsgType&&(clearTimeout(l),d.resolve(0));else{clearTimeout(l),d.resolve(1);const r=e.data?e.data.Error:`${o} error`;t.error(r)}};const i=await r.catch((e=>{throw clearTimeout(l),d.resolve(2),e}));return d.postMessage(i),await c};async function n(e,a,n){const s={error:t("error",a,r),start:t("downloadStart",a),measurement:t("downloadMeasurement",a),complete:t("downloadComplete",a)},d=e.downloadworkerfile||"ndt7-download-worker.min.js";return await o(e,s,n,d,"download").catch((e=>{s.error(e)}))}async function s(e,a,n){const s={error:t("error",a,r),start:t("uploadStart",a),measurement:t("uploadMeasurement",a),complete:t("uploadComplete",a)},d=e.uploadworkerfile||"ndt7-upload-worker.min.js";return await o(e,s,n,d,"upload").catch((e=>{s.error(e)}))<<4}return{discoverServerURLs:a,downloadTest:n,uploadTest:s,test:async function(e,t){const r=a(e,t);return await n(e,t,r)+await s(e,t,r)}}}();"undefined"!=typeof module&&void 0!==module.exports?module.exports=e:window.ndt7=e}();</script> -->
</head>
<body>
    <h1>Internet Speed Test</h1>
    <button id="startTest">Start Test</button>
    <p id="status">Status: Not started</p>
    <p id="downloadSpeed">Download Speed: N/A</p>
    <p id="uploadSpeed">Upload Speed: N/A</p>
    <p id="latency">Latency: N/A</p>

    <script>
        document.getElementById('startTest').addEventListener('click', function() {
            document.getElementById('status').innerText = 'Status: Testing...';

            ndt7.test(
                {
                    userAcceptedDataPolicy: true
                },
                {
                    serverChosen: function(server) {
                        console.log('Testing to:', server);
                    },
                    downloadMeasurement: function(measurement) {
                        document.getElementById('downloadSpeed').innerText = 'Download Speed: ' + measurement.Data.MeanClientMbps + ' Mbps';
                    },
                    uploadMeasurement: function(measurement) {
                        document.getElementById('uploadSpeed').innerText = 'Upload Speed: ' + measurement.Data.MeanClientMbps + ' Mbps';
                    },
                    complete: function() {
                        document.getElementById('status').innerText = 'Status: Complete';
                        sendResultsToSurvey123();
                    }
                }
            );
        });

        function sendResultsToSurvey123() {
            var downloadSpeed = document.getElementById('downloadSpeed').innerText.split(': ')[1];
            var uploadSpeed = document.getElementById('uploadSpeed').innerText.split(': ')[1];
            var latency = document.getElementById('latency').innerText.split(': ')[1];

            var survey123Url = 'arcgis-survey123://?itemID=YOUR_SURVEY_ITEM_ID&field:download_speed=' + downloadSpeed + '&field:upload_speed=' + uploadSpeed + '&field:latency=' + latency;
            window.location.href = survey123Url;
        }
    </script>
</body>
</html>